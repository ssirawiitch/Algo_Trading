//@version=6
strategy("TFEX Trend & Sideway Strategy", overlay=true, default_qty_type=strategy.fixed, commission_value=43.1, slippage=1)

// === INPUT ===
show_labels = input.bool(true, "Show Trend Labels")
rsi_period = input.int(14, "RSI Period", minval=1)
bb_length = input.int(20, "Bollinger Length")
bb_mult = input.float(2.0, "Bollinger Multiplier")
risk_percent = input.float(2.0, "Risk per Trade (%) for Sideway", minval=0.1, maxval=100)
sl_pct_sideway = 5.0  // stop loss 5% in sideway

// === TIMEFRAME HIGHER (H4) ===
ema9_H4 = request.security(syminfo.tickerid, "240", ta.ema(close, 9))
ema21_H4 = request.security(syminfo.tickerid, "240", ta.ema(close, 21))
ema55_H4 = request.security(syminfo.tickerid, "240", ta.ema(close, 55))

// === DETECT TREND (H4) ===
uptrend = ema9_H4 > ema21_H4 and ema21_H4 > ema55_H4
downtrend = ema9_H4 < ema21_H4 and ema21_H4 < ema55_H4
sideway = not uptrend and not downtrend

// === à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ Trend ===
var string lastTrend = "none"
trendNow = uptrend ? "up" : downtrend ? "down" : "side"
trendChanged = trendNow != lastTrend

// === Bollinger Bands (M15) ===
basis = ta.sma(close, bb_length)
dev = bb_mult * ta.stdev(close, bb_length)
upperBB = basis + dev
lowerBB = basis - dev

plot(upperBB, color=color.blue, title="Upper BB")
plot(basis, color=color.gray, title="Middle BB")
plot(lowerBB, color=color.blue, title="Lower BB")

// === RSI ===
rsi = ta.rsi(close, rsi_period)

// === EMA M15 à¸ªà¸³à¸«à¸£à¸±à¸š Cross ===
ema9 = ta.ema(close, 9)
ema21 = ta.ema(close, 21)
bull_cross = ta.crossover(ema9, ema21)
bear_cross = ta.crossunder(ema9, ema21)

// === ENTRY LOGIC ===
// Trend: à¹€à¸—à¸£à¸™à¸”à¹Œà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ â†’ à¹€à¸‚à¹‰à¸²à¸—à¸±à¸™à¸—à¸µ
if trendChanged
    strategy.close_all(comment="Trend changed")

    if trendNow == "up"
        strategy.entry("Long Trend", strategy.long)
    else if trendNow == "down"
        strategy.entry("Short Trend", strategy.short)

    // à¸›à¹‰à¸²à¸¢à¹€à¸—à¸£à¸™à¸”à¹Œ
    if show_labels
        trendColor = trendNow == "up" ? color.green : trendNow == "down" ? color.red : color.gray
        label.new(bar_index, close, text=trendNow == "up" ? "ðŸ“ˆ Uptrend" : trendNow == "down" ? "ðŸ“‰ Downtrend" : "ðŸ”„ Sideway", style=label.style_label_down, color=trendColor, textcolor=color.white)

    lastTrend := trendNow

// Trend: à¸›à¸´à¸” position à¸”à¹‰à¸§à¸¢ EMA cross
if uptrend and bear_cross and strategy.position_size > 0
    strategy.close("Long Trend")

if uptrend and bull_cross and strategy.position_size == 0
    strategy.entry("Long Trend", strategy.long)

if downtrend and bull_cross and strategy.position_size < 0
    strategy.close("Short Trend")

if downtrend and bear_cross and strategy.position_size == 0
    strategy.entry("Short Trend", strategy.short)

// === Sideway Logic ===
// à¸„à¸³à¸™à¸§à¸“ position size à¸ˆà¸²à¸ 2% à¸‚à¸­à¸‡ equity
capital = strategy.equity
risk_amount = capital * (risk_percent / 100)
sl_price_long = close * (1 - sl_pct_sideway / 100)
sl_price_short = close * (1 + sl_pct_sideway / 100)

risk_per_unit_long = close - sl_price_long
risk_per_unit_short = sl_price_short - close

qty_long = risk_per_unit_long > 0 ? risk_amount / risk_per_unit_long : na
qty_short = risk_per_unit_short > 0 ? risk_amount / risk_per_unit_short : na

// Long sideway
if sideway and close < lowerBB and rsi < 30 and not na(qty_long)
    strategy.entry("Long Sideway", strategy.long, qty=qty_long)
    strategy.exit("Exit L", from_entry="Long Sideway", limit=basis, stop=sl_price_long)

// Short sideway
if sideway and close > upperBB and rsi > 70 and not na(qty_short)
    strategy.entry("Short Sideway", strategy.short, qty=qty_short)
    strategy.exit("Exit S", from_entry="Short Sideway", limit=basis, stop=sl_price_short)
